import { body, param, query, validationResult } from \"express-validator\";\nimport {\n  TASK_STATUS,\n  TASK_PRIORITY,\n  VALIDATION,\n  SORT_OPTIONS,\n  SORT_ORDER,\n} from \"../constants/taskConstants.js\";\n\n// Validation middleware to handle validation errors\nexport const handleValidationErrors = (req, res, next) => {\n  const errors = validationResult(req);\n  if (!errors.isEmpty()) {\n    const formattedErrors = errors.array().map(error => ({\n      field: error.path || error.param,\n      message: error.msg,\n      value: error.value,\n    }));\n    \n    return res.status(422).json({\n      success: false,\n      message: \"Validation failed\",\n      errors: formattedErrors,\n    });\n  }\n  next();\n};\n\n// Task creation validation\nexport const validateCreateTask = [\n  body(\"title\")\n    .notEmpty()\n    .withMessage(\"Title is required\")\n    .isLength({ min: 1, max: VALIDATION.TITLE_MAX_LENGTH })\n    .withMessage(`Title must be between 1 and ${VALIDATION.TITLE_MAX_LENGTH} characters`)\n    .trim(),\n  \n  body(\"description\")\n    .optional()\n    .isLength({ max: VALIDATION.DESCRIPTION_MAX_LENGTH })\n    .withMessage(`Description cannot exceed ${VALIDATION.DESCRIPTION_MAX_LENGTH} characters`)\n    .trim(),\n  \n  body(\"dueDate\")\n    .optional()\n    .isISO8601()\n    .withMessage(\"Due date must be in valid ISO 8601 format (YYYY-MM-DD)\")\n    .custom((value) => {\n      if (value) {\n        const dueDate = new Date(value);\n        const today = new Date();\n        today.setHours(0, 0, 0, 0);\n        if (dueDate < today) {\n          throw new Error(\"Due date cannot be in the past\");\n        }\n      }\n      return true;\n    }),\n  \n  body(\"dueTime\")\n    .optional()\n    .matches(/^([01]\\d|2[0-3]):([0-5]\\d)$/)\n    .withMessage(\"Due time must be in HH:MM format (24-hour)\"),\n  \n  body(\"priority\")\n    .optional()\n    .isIn(Object.values(TASK_PRIORITY))\n    .withMessage(\"Priority must be one of: low, medium, high, urgent\"),\n  \n  body(\"assignedTo\")\n    .optional()\n    .isLength({ min: 1 })\n    .withMessage(\"Assigned user ID cannot be empty\"),\n  \n  body(\"tags\")\n    .optional()\n    .isArray()\n    .withMessage(\"Tags must be an array\")\n    .custom((tags) => {\n      if (tags && Array.isArray(tags)) {\n        if (tags.length > VALIDATION.MAX_TAGS_PER_TASK) {\n          throw new Error(`Cannot have more than ${VALIDATION.MAX_TAGS_PER_TASK} tags`);\n        }\n        for (const tag of tags) {\n          if (typeof tag !== 'string') {\n            throw new Error(\"Each tag must be a string\");\n          }\n          if (tag.trim().length === 0) {\n            throw new Error(\"Tags cannot be empty\");\n          }\n          if (tag.length > VALIDATION.TAG_MAX_LENGTH) {\n            throw new Error(`Each tag must be max ${VALIDATION.TAG_MAX_LENGTH} characters\");\n          }\n        }\n      }\n      return true;\n    }),\n  \n  body(\"estimatedHours\")\n    .optional()\n    .isInt({ min: 0 })\n    .withMessage(\"Estimated hours must be a positive integer\"),\n  \n  handleValidationErrors,\n];\n\n// Task update validation\nexport const validateUpdateTask = [\n  param(\"id\")\n    .notEmpty()\n    .withMessage(\"Task ID is required\")\n    .trim(),\n  \n  body(\"title\")\n    .optional()\n    .notEmpty()\n    .withMessage(\"Title cannot be empty\")\n    .isLength({ min: 1, max: VALIDATION.TITLE_MAX_LENGTH })\n    .withMessage(`Title must be between 1 and ${VALIDATION.TITLE_MAX_LENGTH} characters`)\n    .trim(),\n  \n  body(\"description\")\n    .optional()\n    .isLength({ max: VALIDATION.DESCRIPTION_MAX_LENGTH })\n    .withMessage(`Description cannot exceed ${VALIDATION.DESCRIPTION_MAX_LENGTH} characters`)\n    .trim(),\n  \n  body(\"dueDate\")\n    .optional()\n    .isISO8601()\n    .withMessage(\"Due date must be in valid ISO 8601 format (YYYY-MM-DD)\")\n    .custom((value) => {\n      if (value) {\n        const dueDate = new Date(value);\n        const today = new Date();\n        today.setHours(0, 0, 0, 0);\n        if (dueDate < today) {\n          throw new Error(\"Due date cannot be in the past\");\n        }\n      }\n      return true;\n    }),\n  \n  body(\"dueTime\")\n    .optional()\n    .matches(/^([01]\\d|2[0-3]):([0-5]\\d)$/)\n    .withMessage(\"Due time must be in HH:MM format (24-hour)\"),\n  \n  body(\"priority\")\n    .optional()\n    .isIn(Object.values(TASK_PRIORITY))\n    .withMessage(\"Priority must be one of: low, medium, high, urgent\"),\n  \n  body(\"status\")\n    .optional()\n    .isIn(Object.values(TASK_STATUS))\n    .withMessage(\"Status must be one of: pending, in-progress, completed, cancelled\"),\n  \n  body(\"assignedTo\")\n    .optional()\n    .custom((value) => {\n      if (value !== null && (typeof value !== 'string' || value.trim().length === 0)) {\n        throw new Error(\"Assigned user ID cannot be empty string\");\n      }\n      return true;\n    }),\n  \n  body(\"tags\")\n    .optional()\n    .isArray()\n    .withMessage(\"Tags must be an array\")\n    .custom((tags) => {\n      if (tags && Array.isArray(tags)) {\n        if (tags.length > VALIDATION.MAX_TAGS_PER_TASK) {\n          throw new Error(`Cannot have more than ${VALIDATION.MAX_TAGS_PER_TASK} tags`);\n        }\n        for (const tag of tags) {\n          if (typeof tag !== 'string') {\n            throw new Error(\"Each tag must be a string\");\n          }\n          if (tag.trim().length === 0) {\n            throw new Error(\"Tags cannot be empty\");\n          }\n          if (tag.length > VALIDATION.TAG_MAX_LENGTH) {\n            throw new Error(`Each tag must be max ${VALIDATION.TAG_MAX_LENGTH} characters`);\n          }\n        }\n      }\n      return true;\n    }),\n  \n  body(\"estimatedHours\")\n    .optional()\n    .isInt({ min: 0 })\n    .withMessage(\"Estimated hours must be a positive integer\"),\n  \n  body(\"progressPercentage\")\n    .optional()\n    .isInt({ min: 0, max: 100 })\n    .withMessage(\"Progress percentage must be between 0 and 100\"),\n  \n  handleValidationErrors,\n];\n\n// Task ID parameter validation\nexport const validateTaskId = [\n  param(\"id\")\n    .notEmpty()\n    .withMessage(\"Task ID is required\")\n    .trim(),\n  \n  handleValidationErrors,\n];\n\n// Task list query validation\nexport const validateTaskListQuery = [\n  query(\"page\")\n    .optional()\n    .isInt({ min: 1 })\n    .withMessage(\"Page must be a positive integer\"),\n  \n  query(\"limit\")\n    .optional()\n    .isInt({ min: 1, max: 100 })\n    .withMessage(\"Limit must be between 1 and 100\"),\n  \n  query(\"status\")\n    .optional()\n    .custom((value) => {\n      const validStatuses = [...Object.values(TASK_STATUS), 'all'];\n      if (!validStatuses.includes(value)) {\n        throw new Error(`Status must be one of: ${validStatuses.join(', ')}`);\n      }\n      return true;\n    }),\n  \n  query(\"priority\")\n    .optional()\n    .custom((value) => {\n      const validPriorities = [...Object.values(TASK_PRIORITY), 'all'];\n      if (!validPriorities.includes(value)) {\n        throw new Error(`Priority must be one of: ${validPriorities.join(', ')}`);\n      }\n      return true;\n    }),\n  \n  query(\"sortBy\")\n    .optional()\n    .isIn(Object.values(SORT_OPTIONS))\n    .withMessage(`Sort by must be one of: ${Object.values(SORT_OPTIONS).join(', ')}`),\n  \n  query(\"sortOrder\")\n    .optional()\n    .custom((value) => {\n      const upperValue = value.toUpperCase();\n      if (!Object.values(SORT_ORDER).includes(upperValue)) {\n        throw new Error(`Sort order must be one of: ${Object.values(SORT_ORDER).join(', ')}`);\n      }\n      return true;\n    }),\n  \n  query(\"dueDateFrom\")\n    .optional()\n    .isISO8601()\n    .withMessage(\"Due date from must be in valid ISO 8601 format (YYYY-MM-DD)\"),\n  \n  query(\"dueDateTo\")\n    .optional()\n    .isISO8601()\n    .withMessage(\"Due date to must be in valid ISO 8601 format (YYYY-MM-DD)\"),\n  \n  query(\"search\")\n    .optional()\n    .isLength({ min: 1, max: 100 })\n    .withMessage(\"Search query must be between 1 and 100 characters\")\n    .trim(),\n  \n  handleValidationErrors,\n];\n\n// Comment validation\nexport const validateAddComment = [\n  param(\"id\")\n    .notEmpty()\n    .withMessage(\"Task ID is required\")\n    .trim(),\n  \n  body(\"content\")\n    .notEmpty()\n    .withMessage(\"Comment content is required\")\n    .isLength({ min: 1, max: 2000 })\n    .withMessage(\"Comment must be between 1 and 2000 characters\")\n    .trim(),\n  \n  handleValidationErrors,\n];\n