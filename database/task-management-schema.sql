-- Task Management Module - Database Schema
-- This file contains the complete database schema for the task management module

-- =============================================
-- TABLE: tasks
-- =============================================
CREATE TABLE IF NOT EXISTS tasks (
    id BIGSERIAL PRIMARY KEY,
    task_id VARCHAR(50) UNIQUE NOT NULL DEFAULT 'TASK_' || LPAD(nextval('tasks_id_seq')::TEXT, 6, '0'),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    due_date DATE,
    due_time TIME,
    priority VARCHAR(20) NOT NULL DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high', 'urgent')),
    status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'in-progress', 'completed', 'cancelled')),
    
    -- Assignment fields
    assigned_to_user_id VARCHAR(50) REFERENCES users(user_id),
    created_by_user_id VARCHAR(50) NOT NULL REFERENCES users(user_id),
    completed_by_user_id VARCHAR(50) REFERENCES users(user_id),
    
    -- School relationship
    schoolId VARCHAR(50) NOT NULL REFERENCES schools(schoolId),
    
    -- Progress tracking
    estimated_hours INTEGER DEFAULT 0,
    actual_hours INTEGER DEFAULT 0,
    progress_percentage INTEGER DEFAULT 0 CHECK (progress_percentage >= 0 AND progress_percentage <= 100),
    
    -- Tags (stored as JSON array)
    tags JSONB DEFAULT '[]'::jsonb,
    
    -- Timestamps
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP WITH TIME ZONE,
    
    -- Soft delete
    is_active BOOLEAN DEFAULT true,
    deleted_at TIMESTAMP WITH TIME ZONE
);\n\n-- Indexes for tasks table\nCREATE INDEX IF NOT EXISTS idx_tasks_schoolId ON tasks(schoolId);\nCREATE INDEX IF NOT EXISTS idx_tasks_status ON tasks(status);\nCREATE INDEX IF NOT EXISTS idx_tasks_priority ON tasks(priority);\nCREATE INDEX IF NOT EXISTS idx_tasks_assigned_to ON tasks(assigned_to_user_id);\nCREATE INDEX IF NOT EXISTS idx_tasks_created_by ON tasks(created_by_user_id);\nCREATE INDEX IF NOT EXISTS idx_tasks_due_date ON tasks(due_date);\nCREATE INDEX IF NOT EXISTS idx_tasks_is_active ON tasks(is_active);\nCREATE INDEX IF NOT EXISTS idx_tasks_tags ON tasks USING GIN(tags);\n\n-- =============================================\n-- TABLE: task_comments\n-- =============================================\nCREATE TABLE IF NOT EXISTS task_comments (\n    id BIGSERIAL PRIMARY KEY,\n    comment_id VARCHAR(50) UNIQUE NOT NULL DEFAULT 'COMMENT_' || LPAD(nextval('task_comments_id_seq')::TEXT, 6, '0'),\n    task_id BIGINT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    content TEXT NOT NULL,\n    \n    -- User relationship\n    created_by_user_id VARCHAR(50) NOT NULL REFERENCES users(user_id),\n    \n    -- School relationship\n    schoolId VARCHAR(50) NOT NULL REFERENCES schools(schoolId),\n    \n    -- Timestamps\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n    \n    -- Soft delete\n    is_active BOOLEAN DEFAULT true,\n    deleted_at TIMESTAMP WITH TIME ZONE\n);\n\n-- Indexes for task_comments table\nCREATE INDEX IF NOT EXISTS idx_task_comments_task_id ON task_comments(task_id);\nCREATE INDEX IF NOT EXISTS idx_task_comments_created_by ON task_comments(created_by_user_id);\nCREATE INDEX IF NOT EXISTS idx_task_comments_schoolId ON task_comments(schoolId);\nCREATE INDEX IF NOT EXISTS idx_task_comments_is_active ON task_comments(is_active);\n\n-- =============================================\n-- TABLE: task_attachments\n-- =============================================\nCREATE TABLE IF NOT EXISTS task_attachments (\n    id BIGSERIAL PRIMARY KEY,\n    attachment_id VARCHAR(50) UNIQUE NOT NULL DEFAULT 'ATTACH_' || LPAD(nextval('task_attachments_id_seq')::TEXT, 6, '0'),\n    task_id BIGINT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    file_name VARCHAR(255) NOT NULL,\n    file_path VARCHAR(500) NOT NULL,\n    file_size BIGINT NOT NULL,\n    file_type VARCHAR(100) NOT NULL,\n    \n    -- User relationship\n    uploaded_by_user_id VARCHAR(50) NOT NULL REFERENCES users(user_id),\n    \n    -- School relationship\n    schoolId VARCHAR(50) NOT NULL REFERENCES schools(schoolId),\n    \n    -- Timestamps\n    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\n    \n    -- Soft delete\n    is_active BOOLEAN DEFAULT true,\n    deleted_at TIMESTAMP WITH TIME ZONE\n);\n\n-- Indexes for task_attachments table\nCREATE INDEX IF NOT EXISTS idx_task_attachments_task_id ON task_attachments(task_id);\nCREATE INDEX IF NOT EXISTS idx_task_attachments_uploaded_by ON task_attachments(uploaded_by_user_id);\nCREATE INDEX IF NOT EXISTS idx_task_attachments_schoolId ON task_attachments(schoolId);\nCREATE INDEX IF NOT EXISTS idx_task_attachments_is_active ON task_attachments(is_active);\n\n-- =============================================\n-- TABLE: task_history\n-- =============================================\nCREATE TABLE IF NOT EXISTS task_history (\n    id BIGSERIAL PRIMARY KEY,\n    history_id VARCHAR(50) UNIQUE NOT NULL DEFAULT 'HIST_' || LPAD(nextval('task_history_id_seq')::TEXT, 6, '0'),\n    task_id BIGINT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    action VARCHAR(50) NOT NULL,\n    description TEXT NOT NULL,\n    old_value JSONB,\n    new_value JSONB,\n    \n    -- User relationship\n    created_by_user_id VARCHAR(50) NOT NULL REFERENCES users(user_id),\n    \n    -- School relationship\n    schoolId VARCHAR(50) NOT NULL REFERENCES schools(schoolId),\n    \n    -- Timestamps\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Indexes for task_history table\nCREATE INDEX IF NOT EXISTS idx_task_history_task_id ON task_history(task_id);\nCREATE INDEX IF NOT EXISTS idx_task_history_action ON task_history(action);\nCREATE INDEX IF NOT EXISTS idx_task_history_created_by ON task_history(created_by_user_id);\nCREATE INDEX IF NOT EXISTS idx_task_history_schoolId ON task_history(schoolId);\nCREATE INDEX IF NOT EXISTS idx_task_history_created_at ON task_history(created_at);\n\n-- =============================================\n-- TRIGGERS\n-- =============================================\n\n-- Update updated_at timestamp on tasks\nCREATE OR REPLACE FUNCTION update_tasks_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = CURRENT_TIMESTAMP;\n    RETURN NEW;\nEND;\n$$ language 'plpgsql';\n\nCREATE TRIGGER update_tasks_updated_at\n    BEFORE UPDATE ON tasks\n    FOR EACH ROW\n    EXECUTE FUNCTION update_tasks_updated_at();\n\n-- Update updated_at timestamp on task_comments\nCREATE OR REPLACE FUNCTION update_task_comments_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = CURRENT_TIMESTAMP;\n    RETURN NEW;\nEND;\n$$ language 'plpgsql';\n\nCREATE TRIGGER update_task_comments_updated_at\n    BEFORE UPDATE ON task_comments\n    FOR EACH ROW\n    EXECUTE FUNCTION update_task_comments_updated_at();\n\n-- Automatically set completed_at when status changes to completed\nCREATE OR REPLACE FUNCTION set_task_completed_timestamp()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF NEW.status = 'completed' AND OLD.status != 'completed' THEN\n        NEW.completed_at = CURRENT_TIMESTAMP;\n        NEW.progress_percentage = 100;\n    ELSIF NEW.status != 'completed' AND OLD.status = 'completed' THEN\n        NEW.completed_at = NULL;\n        NEW.completed_by_user_id = NULL;\n    END IF;\n    RETURN NEW;\nEND;\n$$ language 'plpgsql';\n\nCREATE TRIGGER set_task_completed_timestamp\n    BEFORE UPDATE ON tasks\n    FOR EACH ROW\n    EXECUTE FUNCTION set_task_completed_timestamp();\n\n-- =============================================\n-- VIEWS\n-- =============================================\n\n-- View for task statistics\nCREATE OR REPLACE VIEW task_statistics AS\nSELECT \n    schoolId,\n    COUNT(*) as total_tasks,\n    COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending_tasks,\n    COUNT(CASE WHEN status = 'in-progress' THEN 1 END) as in_progress_tasks,\n    COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed_tasks,\n    COUNT(CASE WHEN status = 'cancelled' THEN 1 END) as cancelled_tasks,\n    COUNT(CASE WHEN priority = 'urgent' THEN 1 END) as urgent_tasks,\n    COUNT(CASE WHEN priority = 'high' THEN 1 END) as high_priority_tasks,\n    COUNT(CASE WHEN due_date < CURRENT_DATE AND status NOT IN ('completed', 'cancelled') THEN 1 END) as overdue_tasks\nFROM tasks\nWHERE is_active = true\nGROUP BY schoolId;\n\n-- =============================================\n-- SAMPLE DATA (for testing)\n-- =============================================\n\n-- Note: Sample data would go here for testing purposes\n-- INSERT INTO tasks (...) VALUES (...);\n